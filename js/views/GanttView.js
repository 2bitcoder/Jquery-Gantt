var app = app || {};var GanttView = Backbone.View.extend({    el: '.Gantt',    initialize: function() {        this.collection = app.THCollection;        this.$container = this.$el.find('.task-container');        this.$submitButton = this.$el.find('#submitFrom');        this.$submitButton.on('click', function(e) {            this.submitForm(e)        }.bind(this));        this.$el.find('input[name="end"],input[name="start"]').on('change', this.calculateDuration);        this.$menuContainer = this.$el.find('.menu-container');        this.makeSortable();        this.defineContextMenu();        this.listenTo(this.collection, 'sorted add', function() {            this.$container.empty();            this.render();        });    },    makeSortable: function() {        this.$container.sortable({            group: 'sortable',            containerSelector : 'ol',            itemSelector : '.drag-item',            placeholder : '<li class="placeholder sort-placeholder"/>',            onDrag : function($item, position, _super, event) {                var $placeholder = $('.sort-placeholder');                var isSubTask = !$($placeholder.parent()).hasClass('task-container');                $placeholder.css({                    'padding-left' : isSubTask ? '30px' : '0'                });                _super($item, position, _super, event);            }        });    },    events: {        'click #tHandle': 'expand',        'dblclick .sub-task': 'handlerowclick',        'hover .sub-task': 'showMask',        'click .head-bar button': 'handbuttonclick',        'click .new-task': 'openForm',        'click a[href="/#!/generate/"]': 'generatePdf'    },    defineContextMenu: function(){        new ContextMenuView();    },    render: function() {        this.collection.each(function(task) {            this.addTask(task);        }, this);        stagebv = this.canvasView = new app.KCanvasView().render();        this.makeSortable();    },    handlerowclick: function(evt) {        var id = evt.currentTarget.id;        app.tasks.get(id).trigger('editrow', evt);    },    handbuttonclick: function(evt) {        var button = $(evt.currentTarget);        var action = button.data('action');        var interval = action.split('-')[1];        app.setting.set('interval', interval);    },    generatePdf: function(evt){        window.print();        evt.preventDefault();    },    calculateDuration: function(evt){        // Calculating the duration from start and end date        var startdate = new Date($(document).find('input[name="start"]').val());        var enddate = new Date($(document).find('input[name="end"]').val());        var _MS_PER_DAY = 1000 * 60 * 60 * 24;        if(startdate != "" && enddate != ""){            var utc1 = Date.UTC(startdate.getFullYear(), startdate.getMonth(), startdate.getDate());            var utc2 = Date.UTC(enddate.getFullYear(), enddate.getMonth(), enddate.getDate());            $(document).find('input[name="duration"]').val(Math.floor((utc2 - utc1) / _MS_PER_DAY));        }else{            $(document).find('input[name="duration"]').val(Math.floor(0));        }    },    expand: function(evt) {        var target = $(evt.target);        var width = 0;        var setting = app.setting.getSetting('display');        if (target.hasClass('contract')) {            width = setting.tHiddenWidth;        }        else {            width = setting.tableWidth;        }        this.$menuContainer.css('width', width);        //console.log(this.canvasView);        this.canvasView.setWidth(setting.screenWidth - width - 20);        target.toggleClass('contract');        this.$menuContainer.find('.menu-header').toggleClass('menu-header-opened');    },    openForm: function() {        $('.ui.add-new-task').modal('setting', 'transition', 'vertical flip')        .modal('show')        ;    },    addTask: function(task) {        var taski = new app.TaskView({model: task});        this.$container.append(taski.render().el);    },    submitForm: function(e) {        e.preventDefault();        var form = $("#new-task-form");        var data = {};        $(form).serializeArray().forEach(function(input) {            data[input.name] = input.value;        });        var sortindex = 0;        var ref_model = app.tasks.get(data.reference_id);        if (ref_model) {            sortindex = ref_model.get('sortindex') + (data.insertPos === 'above' ? -0.5 : 0.5)        } else {            sortindex = (app.tasks.last().get('sortindex') + 1);        }        data.sortindex = sortindex;        app.tasks.add(data, {parse : true});        console.log(data);        $('.ui.modal').modal('hide');    }});app.GanttView = GanttView;