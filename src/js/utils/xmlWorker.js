"use strict";

var fs = require('fs');
var xml = fs.readFileSync(__dirname + '/xmlTemplate.xml', 'utf8');
var compiled = _.template(xml);

function parseXMLObj(xmlString) {
    var obj = xmlToJSON.parseString(xmlString);
    var tasks = [];
     _.each(obj.Project[0].Tasks[0].Task, function(xmlItem) {
        if (!xmlItem.Name) {
            return;
        }
         tasks.push({
            name : xmlItem.Name[0]._text,
            start : xmlItem.Start[0]._text,
            end : xmlItem.Finish[0]._text,
            complete : xmlItem.PercentComplete[0]._text,
            outline: xmlItem.OutlineNumber[0]._text.toString()
        });
    });
    return tasks;
}

module.exports.parseDepsFromXML = function(xmlString) {
    var obj = xmlToJSON.parseString(xmlString);
    var uids = {};
    var outlines = {};
    var deps = [];
    var parents = [];
    _.each(obj.Project[0].Tasks[0].Task, function(xmlItem) {
        if (!xmlItem.Name) {
            return;
        }
        var item = {
            name: xmlItem.Name[0]._text.toString(),
            outline: xmlItem.OutlineNumber[0]._text.toString()
        };
        uids[xmlItem.UID[0]._text] = item;
        outlines[item.outline] = item;
    });
    _.each(obj.Project[0].Tasks[0].Task, function(xmlItem) {
        if (!xmlItem.Name) {
            return;
        }
        var task = uids[xmlItem.UID[0]._text];
        // var name = xmlItem.Name[0]._text;
        var outline = task.outline;

        if (xmlItem.PredecessorLink) {
            xmlItem.PredecessorLink.forEach((link) => {
                var beforeUID = link.PredecessorUID[0]._text;
                var before = uids[beforeUID];

                deps.push({
                    before: before,
                    after: task
                });
            });

        }

        if (outline.indexOf('.') !== -1) {
            var parentOutline = outline.slice(0,outline.lastIndexOf('.'));
            var parent = outlines[parentOutline];
            if (!parent) {
                console.error('can not find parent');
                return;
            }

            parents.push({
                parent: parent,
                child: task
            });
        }
    });
    return {
        deps : deps,
        parents : parents
    };
};

module.exports.parseXMLObj = parseXMLObj;

module.exports.JSONToXML = function(json) {
    var start = json[0].start;
    var end = json[0].end;
    var data = _.map(json, function(task) {
        if (start > task.start) {
            start = task.start;
        }
        if (end < task.end) {
            end = task.end;
        }
        return {
            id: task.sortindex,
            name : task.name,
            start : task.start.format('yyyy-mm-dd;hh:mm:ss').replace(';', 'T'),
            end : task.end.format('yyyy-mm-dd;hh:mm:ss').replace(';', 'T')
        };
    });
    return compiled({
        tasks : data,
        currentDate : new Date().toISOString(),
        startDate : start,
        finishDate : end
    });
};
